name: Deploy Schema v2

on:
  push:
    paths:
      - 'supabase/migrations/deploy-v2.txt'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install psycopg2-binary
      
      - name: Deploy Schema via Python
        env:
          DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          python3 << 'PYEOF'
          import psycopg2
          import os
          import glob
          
          PASSWORD = os.environ['DB_PASSWORD']
          PROJECT = "mocerqjnksmhcjzxrewo"
          
          # Use the pooler with IPv4
          conn_strings = [
              f"postgresql://postgres.{PROJECT}:{PASSWORD}@aws-0-us-east-1.pooler.supabase.com:6543/postgres?sslmode=require",
              f"postgresql://postgres:{PASSWORD}@db.{PROJECT}.supabase.co:5432/postgres?sslmode=require&options=-c%20timezone%3DUTC",
          ]
          
          conn = None
          for cs in conn_strings:
              try:
                  host = cs.split('@')[1].split('/')[0]
                  print(f"Trying: {host}")
                  conn = psycopg2.connect(cs, connect_timeout=30)
                  conn.autocommit = True
                  print(f"âœ… Connected!")
                  break
              except Exception as e:
                  print(f"âŒ Failed: {str(e)[:80]}")
          
          if not conn:
              print("All connections failed - trying session mode pooler")
              try:
                  conn = psycopg2.connect(
                      f"postgresql://postgres.{PROJECT}:{PASSWORD}@aws-0-us-east-1.pooler.supabase.com:5432/postgres?sslmode=require",
                      connect_timeout=30
                  )
                  conn.autocommit = True
                  print("âœ… Connected via session pooler!")
              except Exception as e:
                  print(f"Final connection failed: {e}")
                  exit(1)
          
          cursor = conn.cursor()
          
          # Run migrations
          for migration in sorted(glob.glob('supabase/migrations/*.sql')):
              if migration.endswith('.txt'):
                  continue
              print(f"
ðŸ“„ Running {migration}...")
              with open(migration, 'r') as f:
                  sql = f.read()
              
              # Split and execute
              success = 0
              errors = 0
              for stmt in sql.split(';'):
                  stmt = stmt.strip()
                  if not stmt or stmt.startswith('--'):
                      continue
                  try:
                      cursor.execute(stmt + ';')
                      success += 1
                  except Exception as e:
                      err = str(e)
                      if 'already exists' in err.lower() or 'duplicate' in err.lower():
                          success += 1
                      else:
                          errors += 1
                          if errors <= 3:
                              print(f"  âš ï¸ {err[:60]}")
              print(f"  âœ… {success} statements, {errors} errors")
          
          # Verify
          print("
ðŸ“Š Verification:")
          try:
              cursor.execute("SELECT COUNT(*) FROM kpi_definitions;")
              count = cursor.fetchone()[0]
              print(f"  KPIs: {count}")
          except:
              print("  KPIs: table not found")
          
          try:
              cursor.execute("SELECT category, COUNT(*) FROM kpi_definitions GROUP BY category ORDER BY category;")
              for row in cursor.fetchall():
                  print(f"    {row[0]}: {row[1]}")
          except:
              pass
          
          cursor.close()
          conn.close()
          print("
ðŸŽ‰ DONE!")
          PYEOF
