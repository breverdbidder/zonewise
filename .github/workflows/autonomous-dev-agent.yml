name: ZoneWise Autonomous Dev Agent V2

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Development task to execute'
        required: true
        default: 'Build CrewAI Compliance Agent using zoning_districts data'
      max_iterations:
        description: 'Maximum iterations before checkpoint'
        required: false
        default: '15'
      model_tier:
        description: 'Model tier: FREE (Gemini 1M), CHEAP (DeepSeek), PREMIUM (Claude)'
        required: false
        default: 'FREE'
  schedule:
    - cron: '0 7 * * *'

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

jobs:
  autonomous-dev:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install google-genai anthropic httpx supabase
      
      - name: Run Smart Router Development Agent
        run: |
          python3 << 'PYEOF'
          from google import genai
          from google.genai import types
          import anthropic
          import json
          import os
          import subprocess
          import httpx
          from pathlib import Path
          
          # ============================================================
          # SMART ROUTER V5 - GEMINI 2.5 FLASH (1M CONTEXT, FREE)
          # ============================================================
          
          MODEL_TIER = "${{ github.event.inputs.model_tier }}" or "FREE"
          MAX_ITERATIONS = int("${{ github.event.inputs.max_iterations }}" or "15")
          TASK = """${{ github.event.inputs.task }}""" or "Continue ZoneWise development"
          
          print(f"""
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë  ZONEWISE AUTONOMOUS DEV AGENT V2                            ‚ïë
          ‚ïë  Smart Router: {MODEL_TIER.ljust(45)}‚ïë
          ‚ïë  Context Window: 1,000,000 tokens (1M)                       ‚ïë
          ‚ïë  Cost: $0 (FREE tier)                                        ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          """)
          
          # Load context files
          claude_md = Path("CLAUDE.md").read_text() if Path("CLAUDE.md").exists() else ""
          poc_status = Path("POC_STATUS.md").read_text() if Path("POC_STATUS.md").exists() else ""
          
          # Load checkpoint
          checkpoint_context = ""
          try:
              response = httpx.get(
                  f"{os.environ['SUPABASE_URL']}/rest/v1/claude_context_checkpoints",
                  params={"conversation_id": "like.zonewise*", "order": "created_at.desc", "limit": 1},
                  headers={
                      "apikey": os.environ['SUPABASE_SERVICE_KEY'],
                      "Authorization": f"Bearer {os.environ['SUPABASE_SERVICE_KEY']}"
                  },
                  verify=False
              )
              checkpoints = response.json()
              if checkpoints:
                  cp = checkpoints[0]
                  checkpoint_context = f"Previous: {cp.get('checkpoint_summary', '')}"
                  print(f"üìå Loaded checkpoint: {checkpoint_context[:80]}...")
          except Exception as e:
              print(f"No checkpoint: {e}")
          
          # SYSTEM PROMPT - Define BEFORE use
          SYSTEM = f"""You are an autonomous AI development agent for ZoneWise.

          # PROJECT CONTEXT
          {claude_md[:2000]}

          # CURRENT STATE  
          {poc_status[:1500]}

          {checkpoint_context}

          # CAPABILITIES - Output JSON actions:
          {{"action": "write_file", "path": "path/to/file.py", "content": "full file content"}}
          {{"action": "execute", "command": "python script.py"}}
          {{"action": "read_file", "path": "existing_file.py"}}
          {{"action": "commit", "message": "feat: description"}}
          {{"action": "checkpoint", "summary": "progress", "next_steps": ["task1"]}}
          {{"action": "done", "summary": "completed"}}

          # RULES
          1. Execute autonomously - NO asking for permission
          2. Write COMPLETE working code - not snippets
          3. Output ONE action at a time as valid JSON
          4. After write_file, verify with read_file
          5. Commit after each major file creation
          """
          
          # Configure Gemini
          if MODEL_TIER == "FREE":
              client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])
              USE_GEMINI = True
              print("üü¢ Using Gemini 2.5 Flash (1M context, $0)")
          else:
              anthropic_client = anthropic.Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
              USE_GEMINI = False
              print("üî¥ Using Claude Sonnet 4.5 (200K context, PREMIUM)")
          
          def call_llm(prompt: str) -> str:
              """Call LLM via Smart Router"""
              full_prompt = SYSTEM + "\n\nCurrent task: " + prompt
              if USE_GEMINI:
                  response = client.models.generate_content(
                      model="gemini-2.0-flash-exp",
                      contents=full_prompt,
                      config=types.GenerateContentConfig(max_output_tokens=8192)
                  )
                  return response.text
              else:
                  response = anthropic_client.messages.create(
                      model="claude-sonnet-4-5-20250929",
                      max_tokens=8192,
                      system=SYSTEM,
                      messages=[{"role": "user", "content": prompt}]
                  )
                  return response.content[0].text
          
          def execute_action(action: dict) -> str:
              """Execute an action and return result"""
              action_type = action.get('action')
              
              if action_type == 'write_file':
                  path = Path(action['path'])
                  path.parent.mkdir(parents=True, exist_ok=True)
                  path.write_text(action['content'])
                  return f"‚úÖ Wrote {len(action['content'])} chars to {path}"
              
              elif action_type == 'read_file':
                  path = Path(action['path'])
                  if path.exists():
                      return f"üìÑ {path}:\n{path.read_text()[:2000]}"
                  return f"‚ùå Not found: {path}"
              
              elif action_type == 'execute':
                  try:
                      result = subprocess.run(action['command'], shell=True, capture_output=True, text=True, timeout=120)
                      return f"‚úÖ {action['command']}\nstdout: {result.stdout[:500]}\nstderr: {result.stderr[:200]}"
                  except Exception as e:
                      return f"‚ùå Error: {e}"
              
              elif action_type == 'commit':
                  try:
                      subprocess.run(['git', 'add', '-A'], check=True)
                      subprocess.run(['git', 'commit', '-m', action['message']], check=True)
                      return f"‚úÖ Committed: {action['message']}"
                  except Exception as e:
                      return f"‚ùå Commit: {e}"
              
              elif action_type == 'checkpoint':
                  httpx.post(
                      f"{os.environ['SUPABASE_URL']}/rest/v1/claude_context_checkpoints",
                      headers={"apikey": os.environ['SUPABASE_SERVICE_KEY'], "Authorization": f"Bearer {os.environ['SUPABASE_SERVICE_KEY']}", "Content-Type": "application/json"},
                      json={"conversation_id": f"zonewise-v2-{os.environ.get('GITHUB_RUN_ID','')}", "checkpoint_number": 1, "context_percent": 50, "checkpoint_summary": action.get('summary',''), "active_tasks": action.get('next_steps',[]), "key_points": {}},
                      verify=False
                  )
                  return "‚úÖ Checkpoint saved"
              
              elif action_type == 'done':
                  return f"üéâ COMPLETE: {action.get('summary','')}"
              
              return f"‚ùì Unknown: {action_type}"
          
          # MAIN LOOP
          import re
          current_prompt = TASK
          results = []
          
          for i in range(MAX_ITERATIONS):
              print(f"\n{'='*60}\nITERATION {i+1}/{MAX_ITERATIONS} | Gemini 2.5 Flash | 1M Context\n{'='*60}")
              
              response = call_llm(current_prompt)
              print(f"Response: {response[:500]}...")
              
              # Find JSON action
              json_match = re.search(r'\{[^{}]*"action"[^{}]*\}', response, re.DOTALL)
              if json_match:
                  try:
                      action = json.loads(json_match.group())
                      result = execute_action(action)
                      print(result)
                      results.append(result)
                      
                      if action.get('action') == 'done':
                          break
                      
                      current_prompt = f"Previous result: {result}\n\nContinue with next step of: {TASK}"
                  except json.JSONDecodeError as e:
                      print(f"JSON error: {e}")
                      current_prompt = f"Invalid JSON. Output a single valid JSON action for: {TASK}"
              else:
                  print("No action found in response")
                  current_prompt = f"No action detected. Output a JSON action like {{'action':'write_file','path':'...','content':'...'}} for: {TASK}"
          
          # Push changes
          try:
              subprocess.run(['git', 'config', 'user.name', 'ZoneWise Agent'], check=True)
              subprocess.run(['git', 'config', 'user.email', 'agent@zonewise.ai'], check=True)
              subprocess.run(['git', 'push', 'origin', 'main'], check=True)
              print("‚úÖ Pushed to GitHub")
          except Exception as e:
              print(f"Push: {e}")
          
          print(f"\n{'='*60}\nSESSION COMPLETE: {len(results)} actions\n{'='*60}")
          PYEOF
      
      - name: Final checkpoint
        if: always()
        run: |
          python3 -c "
          import httpx, os
          httpx.post(
              f\"{os.environ['SUPABASE_URL']}/rest/v1/claude_context_checkpoints\",
              headers={'apikey': os.environ['SUPABASE_SERVICE_KEY'], 'Authorization': f\"Bearer {os.environ['SUPABASE_SERVICE_KEY']}\", 'Content-Type': 'application/json'},
              json={'conversation_id': f\"zonewise-v2-{os.environ.get('GITHUB_RUN_ID','final')}\", 'checkpoint_number': 999, 'context_percent': 100, 'checkpoint_summary': 'Session complete', 'active_tasks': [], 'key_points': {'model': 'gemini-2.0-flash-exp'}},
              verify=False
          )
          print('‚úÖ Final checkpoint')
          "
