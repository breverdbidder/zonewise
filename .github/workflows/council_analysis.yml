name: AI Council Analysis

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform (zonewise, spd, biddeed)'
        required: true
        type: choice
        options:
          - biddeed
          - zonewise
          - spd
      subject:
        description: 'Property address or project name'
        required: true
        type: string
      query:
        description: 'Analysis question'
        required: true
        type: string
      context_json:
        description: 'JSON context data (optional)'
        required: false
        type: string
        default: '{}'

  repository_dispatch:
    types: [run-council]

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

jobs:
  run-council:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install langgraph httpx pydantic python-dotenv
          pip install supabase || true
      
      - name: Run AI Council
        id: council
        run: |
          # Set inputs from workflow_dispatch or repository_dispatch
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            PLATFORM="${{ github.event.client_payload.platform }}"
            SUBJECT="${{ github.event.client_payload.subject }}"
            QUERY="${{ github.event.client_payload.query }}"
            CONTEXT='${{ github.event.client_payload.context }}'
          else
            PLATFORM="${{ inputs.platform }}"
            SUBJECT="${{ inputs.subject }}"
            QUERY="${{ inputs.query }}"
            CONTEXT='${{ inputs.context_json }}'
          fi
          
          # Create output directory
          mkdir -p council_output
          
          # Add src to Python path and run
          cd $GITHUB_WORKSPACE
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}/src/council"
          
          # Run council analysis with inline script to handle imports
          python3 << PYEOF
import sys
import os
import json
import asyncio
from datetime import datetime

# Add council module to path
sys.path.insert(0, os.path.join(os.getcwd(), 'src', 'council'))

# Import after path setup
from council_prompts import Platform, get_council_agents, create_shared_reasoning_file
from council_workflow import run_council

async def main():
    platform = "$PLATFORM"
    subject = "$SUBJECT"
    query = "$QUERY"
    context = json.loads('$CONTEXT')
    
    print(f"Running AI Council for: {subject}")
    print(f"Platform: {platform}")
    print(f"Query: {query}")
    
    try:
        result = await run_council(
            platform=platform,
            subject=subject,
            query=query,
            context=context,
            output_dir="council_output"
        )
        
        print(f"\nâœ… Council Complete!")
        print(f"Confidence: {result.get('confidence', 0):.2f}")
        print(f"Execution Time: {result.get('execution_time_ms', 0)}ms")
        
    except Exception as e:
        print(f"âŒ Council Error: {e}")
        # Create minimal output on error
        error_result = {
            "council_id": "error",
            "platform": platform,
            "subject": subject,
            "query": query,
            "error": str(e),
            "created_at": datetime.utcnow().isoformat()
        }
        with open("council_output/council_result.json", "w") as f:
            json.dump(error_result, f, indent=2)
        
        # Create minimal shared_reasoning.md
        with open("council_output/shared_reasoning.md", "w") as f:
            f.write(f"# AI Council Analysis: {subject}\n\n")
            f.write(f"**Error:** {e}\n")
        
        raise

asyncio.run(main())
PYEOF
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: council-analysis-${{ github.run_id }}
          path: council_output/
          retention-days: 30
      
      - name: Save to Supabase
        if: success()
        continue-on-error: true
        run: |
          python3 << 'PYEOF'
import json
import os

try:
    from supabase import create_client
    
    url = os.environ.get('SUPABASE_URL', '')
    key = os.environ.get('SUPABASE_SERVICE_KEY', '')
    
    if url and key:
        client = create_client(url, key)
        
        with open('council_output/council_result.json') as f:
            result = json.load(f)
        
        with open('council_output/shared_reasoning.md') as f:
            reasoning = f.read()
        
        # Insert into council_analyses table
        client.table('council_analyses').insert({
            'council_id': result.get('council_id', 'unknown'),
            'platform': result.get('platform', ''),
            'subject': result.get('subject', ''),
            'query': result.get('query', ''),
            'recommendation': result.get('recommendation', ''),
            'confidence': result.get('confidence', 0),
            'action_items': result.get('action_items', []),
            'execution_time_ms': result.get('execution_time_ms', 0),
            'token_usage': result.get('token_usage', {}),
            'shared_reasoning': reasoning
        }).execute()
        
        print(f"âœ… Saved council analysis to Supabase")
    else:
        print("âš ï¸ Supabase credentials not configured")
        
except ImportError:
    print("âš ï¸ Supabase client not installed")
except Exception as e:
    print(f"âš ï¸ Failed to save to Supabase: {e}")
PYEOF
      
      - name: Post summary
        if: always()
        run: |
          echo "## AI Council Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f council_output/council_result.json ]; then
            RESULT=$(cat council_output/council_result.json)
            CONFIDENCE=$(echo $RESULT | python3 -c "import sys,json; print(json.load(sys.stdin).get('confidence', 'N/A'))" 2>/dev/null || echo "N/A")
            EXECUTION_TIME=$(echo $RESULT | python3 -c "import sys,json; print(json.load(sys.stdin).get('execution_time_ms', 'N/A'))" 2>/dev/null || echo "N/A")
            
            echo "**Platform:** ${{ inputs.platform || github.event.client_payload.platform }}" >> $GITHUB_STEP_SUMMARY
            echo "**Subject:** ${{ inputs.subject || github.event.client_payload.subject }}" >> $GITHUB_STEP_SUMMARY
            echo "**Confidence:** ${CONFIDENCE}" >> $GITHUB_STEP_SUMMARY
            echo "**Execution Time:** ${EXECUTION_TIME}ms" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No result file generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ Full analysis available in artifacts" >> $GITHUB_STEP_SUMMARY
