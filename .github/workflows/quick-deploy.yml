name: Quick Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install psycopg2
        run: pip install psycopg2-binary
      
      - name: Deploy
        env:
          DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          python3 -c "
          import psycopg2
          import os
          import glob
          
          pw = os.environ['DB_PASSWORD']
          proj = 'mocerqjnksmhcjzxrewo'
          
          print('Connecting to Supabase...')
          conn = psycopg2.connect(
              f'postgresql://postgres.{proj}:{pw}@aws-0-us-east-1.pooler.supabase.com:6543/postgres?sslmode=require',
              connect_timeout=60
          )
          conn.autocommit = True
          cur = conn.cursor()
          print('Connected!')
          
          for mig in sorted(glob.glob('supabase/migrations/*.sql')):
              if mig.endswith('.txt'): continue
              print(f'Running {mig}...')
              with open(mig) as f:
                  sql = f.read()
              for stmt in sql.split(';'):
                  stmt = stmt.strip()
                  if not stmt or stmt.startswith('--'): continue
                  try:
                      cur.execute(stmt + ';')
                  except Exception as e:
                      if 'already exists' not in str(e).lower():
                          print(f'  Error: {str(e)[:60]}')
              print(f'  Done')
          
          cur.execute('SELECT COUNT(*) FROM kpi_definitions;')
          print(f'KPIs: {cur.fetchone()[0]}')
          conn.close()
          print('Done!')
          "
