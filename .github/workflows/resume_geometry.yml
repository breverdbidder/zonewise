name: Resume Geometry Download

on:
  workflow_dispatch:

jobs:
  fetch-geometry:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Fetch remaining geometry
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          python3 << 'PYTHON'
          import os
          import json
          import urllib.request
          import urllib.parse
          import ssl
          import time

          SUPABASE_URL = os.environ["SUPABASE_URL"]
          SUPABASE_KEY = os.environ["SUPABASE_KEY"]
          BCPAO_URL = "https://gis.brevardfl.gov/gissrv/rest/services/Base_Map/Parcel_New_WKID2881/MapServer/5/query"

          ctx = ssl.create_default_context()
          ctx.check_hostname = False
          ctx.verify_mode = ssl.CERT_NONE

          def supabase_request(endpoint, method="GET", data=None):
              url = f"{SUPABASE_URL}/rest/v1/{endpoint}"
              headers = {
                  "apikey": SUPABASE_KEY,
                  "Authorization": f"Bearer {SUPABASE_KEY}",
                  "Content-Type": "application/json",
                  "Prefer": "return=minimal"
              }
              req = urllib.request.Request(url, headers=headers, method=method)
              if data:
                  req.data = json.dumps(data).encode()
              try:
                  with urllib.request.urlopen(req, timeout=30, context=ctx) as resp:
                      return resp.read().decode() if method == "GET" else True
              except Exception as e:
                  print(f"Supabase error: {e}")
                  return None

          def get_parcels_without_geometry(limit=500, offset=0):
              endpoint = f"sample_properties?select=id,parcel_id&geometry=is.null&limit={limit}&offset={offset}"
              result = supabase_request(endpoint)
              return json.loads(result) if result else []

          def fetch_bcpao_geometry(parcel_ids):
              """Fetch geometry for batch of parcels from BCPAO"""
              where_clause = " OR ".join([f"PARCEL_ID='{pid}'" for pid in parcel_ids])
              params = {
                  "where": where_clause,
                  "outFields": "PARCEL_ID",
                  "returnGeometry": "true",
                  "outSR": "4326",
                  "f": "json"
              }
              url = f"{BCPAO_URL}?{urllib.parse.urlencode(params)}"
              try:
                  req = urllib.request.Request(url)
                  with urllib.request.urlopen(req, timeout=60, context=ctx) as resp:
                      data = json.loads(resp.read().decode())
                      return {f["attributes"]["PARCEL_ID"]: f["geometry"] for f in data.get("features", [])}
              except Exception as e:
                  print(f"BCPAO error: {e}")
                  return {}

          def update_geometry(parcel_id, geometry):
              endpoint = f"sample_properties?parcel_id=eq.{urllib.parse.quote(parcel_id)}"
              return supabase_request(endpoint, "PATCH", {"geometry": geometry})

          # Main loop
          total_updated = 0
          batch_num = 0
          BATCH_SIZE = 25

          while True:
              parcels = get_parcels_without_geometry(limit=500, offset=0)
              if not parcels:
                  print(f"Done! Total updated: {total_updated}")
                  break

              print(f"Found {len(parcels)} parcels without geometry")

              for i in range(0, len(parcels), BATCH_SIZE):
                  batch = parcels[i:i+BATCH_SIZE]
                  parcel_ids = [p["parcel_id"] for p in batch]
                  
                  geometries = fetch_bcpao_geometry(parcel_ids)
                  
                  for parcel in batch:
                      pid = parcel["parcel_id"]
                      if pid in geometries and geometries[pid]:
                          if update_geometry(pid, geometries[pid]):
                              total_updated += 1

                  batch_num += 1
                  if batch_num % 10 == 0:
                      print(f"Progress: {total_updated} parcels updated")
                  
                  time.sleep(0.2)  # Rate limit

              print(f"Batch complete. Total: {total_updated}")
          PYTHON
