name: Deploy ZoneWise Schema

on:
  workflow_dispatch:
    inputs:
      migration:
        description: 'Migration to run'
        required: true
        default: '003_zonewise_298_kpi'
        type: string
      confirm:
        description: 'Type DEPLOY to confirm'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'DEPLOY' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      
      - name: Deploy Schema
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "ðŸš€ Deploying ${{ inputs.migration }}.sql to Supabase..."
          
          # Use direct connection
          psql "postgresql://postgres:${PGPASSWORD}@db.mocerqjnksmhcjzxrewo.supabase.co:5432/postgres" \
            -f supabase/migrations/${{ inputs.migration }}.sql
          
          echo "âœ… Schema deployed!"
          
          # Verify
          psql "postgresql://postgres:${PGPASSWORD}@db.mocerqjnksmhcjzxrewo.supabase.co:5432/postgres" \
            -c "SELECT category, COUNT(*) FROM kpi_definitions GROUP BY category ORDER BY category;"
