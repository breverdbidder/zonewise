name: Deploy ZoneWise Schema

on:
  workflow_dispatch:
    inputs:
      migration:
        description: 'Migration to run (003_zonewise_298_kpi)'
        required: true
        default: '003_zonewise_298_kpi'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install supabase httpx
      
      - name: Deploy Schema via Supabase SDK
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          python3 << 'PYEOF'
import os
import httpx
import json

SUPABASE_URL = os.environ['SUPABASE_URL']
SUPABASE_KEY = os.environ['SUPABASE_KEY']

# Read migration file
with open('supabase/migrations/${{ inputs.migration }}.sql', 'r') as f:
    sql_content = f.read()

# Split into individual statements
statements = [s.strip() for s in sql_content.split(';') if s.strip() and not s.strip().startswith('--')]

print(f"ðŸ“Š Found {len(statements)} SQL statements to execute")

# For CREATE TABLE and INSERT, we need to use the SQL API endpoint
# Supabase doesn't expose raw SQL via REST, but we can use the pg API

# Check connection first
response = httpx.get(
    f"{SUPABASE_URL}/rest/v1/",
    headers={
        "apikey": SUPABASE_KEY,
        "Authorization": f"Bearer {SUPABASE_KEY}"
    }
)
print(f"Connection test: {response.status_code}")

# Print instructions for manual deployment
print("
" + "="*60)
print("âš ï¸  SUPABASE REST API CANNOT EXECUTE DDL (CREATE TABLE)")
print("="*60)
print("
To deploy the 298 KPI schema:")
print("1. Go to: https://supabase.com/dashboard/project/mocerqjnksmhcjzxrewo/sql")
print("2. Copy contents of: supabase/migrations/003_zonewise_298_kpi.sql")
print("3. Click 'Run' to execute")
print("
Alternatively, use Supabase CLI:")
print("  supabase db push --db-url postgresql://postgres:PASSWORD@db.mocerqjnksmhcjzxrewo.supabase.co:5432/postgres")
PYEOF
