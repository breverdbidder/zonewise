name: Add Geometry to Parcels

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Records per BCPAO request'
        required: true
        default: '100'

jobs:
  add-geometry:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch geometry and update parcels
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BATCH_SIZE: ${{ inputs.batch_size }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          import requests
          import json
          import time

          SUPABASE_URL = os.environ["SUPABASE_URL"]
          SUPABASE_KEY = os.environ["SUPABASE_SERVICE_KEY"]
          BCPAO_URL = "https://gis.brevardfl.gov/gissrv/rest/services/Base_Map/Parcel_New_WKID2881/MapServer/5/query"

          BATCH_SIZE = int(os.environ.get("BATCH_SIZE", "100"))

          headers = {
              "apikey": SUPABASE_KEY,
              "Authorization": f"Bearer {SUPABASE_KEY}",
              "Content-Type": "application/json"
          }

          def get_total_count():
              """Get total parcels count."""
              r = requests.get(
                  f"{SUPABASE_URL}/rest/v1/sample_properties?select=id",
                  headers={**headers, "Prefer": "count=exact"},
                  timeout=30
              )
              count = r.headers.get("content-range", "").split("/")[-1]
              return int(count) if count.isdigit() else 0

          def get_parcel_batch(offset, limit):
              """Get batch of parcel_ids by offset."""
              r = requests.get(
                  f"{SUPABASE_URL}/rest/v1/sample_properties",
                  headers=headers,
                  params={
                      "select": "id,parcel_id",
                      "order": "id",
                      "offset": offset,
                      "limit": limit
                  },
                  timeout=60
              )
              if r.status_code == 200:
                  return r.json()
              return []

          def fetch_geometry_from_bcpao(parcel_ids):
              """Fetch geometry from BCPAO for parcel IDs."""
              if not parcel_ids:
                  return {}
              
              # Escape parcel IDs for SQL
              escaped = [pid.replace("'", "''") for pid in parcel_ids]
              where = f"PARCEL_ID IN ({','.join(f\"'{p}'\" for p in escaped)})"
              
              params = {
                  "where": where,
                  "outFields": "PARCEL_ID",
                  "returnGeometry": "true",
                  "outSR": "4326",
                  "f": "json"
              }
              
              try:
                  r = requests.get(BCPAO_URL, params=params, timeout=120)
                  data = r.json()
                  
                  if "error" in data:
                      return {}
                  
                  result = {}
                  for f in data.get("features", []):
                      pid = f.get("attributes", {}).get("PARCEL_ID")
                      geom = f.get("geometry")
                      if pid and geom:
                          result[pid] = geom
                  return result
              except Exception as e:
                  print(f"  BCPAO error: {e}")
                  return {}

          def update_parcel_geometry(record_id, geometry):
              """Update single parcel with geometry."""
              try:
                  r = requests.patch(
                      f"{SUPABASE_URL}/rest/v1/sample_properties?id=eq.{record_id}",
                      headers=headers,
                      json={"geometry": geometry},
                      timeout=30
                  )
                  return r.status_code in [200, 204]
              except:
                  return False

          # Main
          print("=" * 70)
          print("ZoneWise - Adding Geometry to ALL Parcels")
          print("=" * 70)

          total = get_total_count()
          print(f"Total parcels: {total:,}")
          print(f"Batch size: {BATCH_SIZE}")
          print(f"Estimated batches: {(total // BATCH_SIZE) + 1}")
          print("=" * 70)

          offset = 0
          total_updated = 0
          batch_num = 0

          while offset < total:
              batch_num += 1
              
              # Get parcels from Supabase
              parcels = get_parcel_batch(offset, BATCH_SIZE)
              if not parcels:
                  print(f"  No parcels at offset {offset}")
                  break
              
              parcel_ids = [p["parcel_id"] for p in parcels]
              id_map = {p["parcel_id"]: p["id"] for p in parcels}
              
              # Fetch geometry from BCPAO
              geometries = fetch_geometry_from_bcpao(parcel_ids)
              
              # Update each parcel
              batch_updated = 0
              for pid, geom in geometries.items():
                  if pid in id_map:
                      if update_parcel_geometry(id_map[pid], geom):
                          batch_updated += 1
              
              total_updated += batch_updated
              
              if batch_num % 50 == 0:
                  pct = (offset / total) * 100
                  print(f"Batch {batch_num}: {total_updated:,} updated ({pct:.1f}%)")
              
              offset += BATCH_SIZE
              time.sleep(0.2)

          print("=" * 70)
          print(f"COMPLETE: {total_updated:,} parcels updated with geometry")
          print("=" * 70)
          PYTHON_SCRIPT

      - name: Verify geometry counts
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "=== Geometry Stats ==="
          python3 << 'EOF'
          import requests
          import os
          
          url = os.environ["SUPABASE_URL"]
          key = os.environ["SUPABASE_SERVICE_KEY"]
          headers = {"apikey": key, "Authorization": f"Bearer {key}"}
          
          # Count with geometry
          r = requests.get(
              f"{url}/rest/v1/sample_properties?select=id&geometry=not.is.null",
              headers={**headers, "Prefer": "count=exact"}
          )
          with_geom = r.headers.get("content-range", "0/0").split("/")[-1]
          
          # Total
          r2 = requests.get(
              f"{url}/rest/v1/sample_properties?select=id",
              headers={**headers, "Prefer": "count=exact"}
          )
          total = r2.headers.get("content-range", "0/0").split("/")[-1]
          
          print(f"With geometry: {with_geom}")
          print(f"Total parcels: {total}")
          EOF
