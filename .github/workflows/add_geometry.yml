name: Add Geometry to Parcels

on:
  workflow_dispatch:
    inputs:
      bcpao_batch:
        description: 'Parcels per BCPAO request (keep small)'
        required: true
        default: '25'
      start_id:
        description: 'Start from record ID (for resuming)'
        required: true
        default: '0'

jobs:
  add-geometry:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch geometry and update parcels
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BCPAO_BATCH: ${{ inputs.bcpao_batch }}
          START_ID: ${{ inputs.start_id }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          import requests
          import json
          import time

          SUPABASE_URL = os.environ["SUPABASE_URL"]
          SUPABASE_KEY = os.environ["SUPABASE_SERVICE_KEY"]
          BCPAO_URL = "https://gis.brevardfl.gov/gissrv/rest/services/Base_Map/Parcel_New_WKID2881/MapServer/5/query"

          BCPAO_BATCH = int(os.environ.get("BCPAO_BATCH", "25"))
          START_ID = int(os.environ.get("START_ID", "0"))
          SUPABASE_BATCH = 500  # Records to fetch from Supabase at once

          headers = {
              "apikey": SUPABASE_KEY,
              "Authorization": f"Bearer {SUPABASE_KEY}",
              "Content-Type": "application/json"
          }

          def get_parcels_batch(last_id, limit):
              """Get parcels with ID > last_id."""
              url = f"{SUPABASE_URL}/rest/v1/sample_properties"
              params = {
                  "select": "id,parcel_id",
                  "id": f"gt.{last_id}",
                  "order": "id",
                  "limit": limit
              }
              try:
                  r = requests.get(url, headers=headers, params=params, timeout=60)
                  if r.status_code == 200:
                      return r.json()
              except Exception as e:
                  print(f"Supabase error: {e}")
              return []

          def fetch_single_geometry(parcel_id):
              """Fetch geometry for a single parcel."""
              escaped = parcel_id.replace("'", "''")
              params = {
                  "where": f"PARCEL_ID='{escaped}'",
                  "outFields": "PARCEL_ID",
                  "returnGeometry": "true",
                  "outSR": "4326",
                  "f": "json"
              }
              try:
                  r = requests.get(BCPAO_URL, params=params, timeout=30)
                  if r.status_code == 200:
                      data = r.json()
                      features = data.get("features", [])
                      if features:
                          return features[0].get("geometry")
              except:
                  pass
              return None

          def fetch_geometry_batch(parcel_ids):
              """Fetch geometry for multiple parcels."""
              if not parcel_ids:
                  return {}
              
              # Build WHERE clause
              escaped = [pid.replace("'", "''") for pid in parcel_ids]
              quoted = ["'" + p + "'" for p in escaped]
              where = "PARCEL_ID IN (" + ",".join(quoted) + ")"
              
              params = {
                  "where": where,
                  "outFields": "PARCEL_ID",
                  "returnGeometry": "true",
                  "outSR": "4326",
                  "f": "json"
              }
              
              try:
                  r = requests.get(BCPAO_URL, params=params, timeout=60)
                  if r.status_code != 200:
                      return {}
                  
                  text = r.text.strip()
                  if not text or text[0] != '{':
                      return {}
                  
                  data = r.json()
                  if "error" in data:
                      return {}
                  
                  result = {}
                  for f in data.get("features", []):
                      pid = f.get("attributes", {}).get("PARCEL_ID")
                      geom = f.get("geometry")
                      if pid and geom:
                          result[pid] = geom
                  return result
              except:
                  return {}

          def update_parcel_geometry(record_id, geometry):
              """Update single parcel with geometry."""
              try:
                  r = requests.patch(
                      f"{SUPABASE_URL}/rest/v1/sample_properties?id=eq.{record_id}",
                      headers=headers,
                      json={"geometry": geometry},
                      timeout=30
                  )
                  return r.status_code in [200, 204]
              except:
                  return False

          print("=" * 70)
          print("ZoneWise - Adding Geometry (Optimized)")
          print(f"BCPAO batch: {BCPAO_BATCH} | Start ID: {START_ID}")
          print("=" * 70)

          last_id = START_ID
          total_updated = 0
          total_processed = 0
          round_num = 0

          while True:
              round_num += 1
              
              # Get batch from Supabase
              parcels = get_parcels_batch(last_id, SUPABASE_BATCH)
              if not parcels:
                  print("No more parcels")
                  break
              
              # Process in small BCPAO batches
              for i in range(0, len(parcels), BCPAO_BATCH):
                  chunk = parcels[i:i+BCPAO_BATCH]
                  parcel_ids = [p["parcel_id"] for p in chunk]
                  id_map = {p["parcel_id"]: p["id"] for p in chunk}
                  
                  # Fetch geometry
                  geometries = fetch_geometry_batch(parcel_ids)
                  
                  # Update records
                  for pid, geom in geometries.items():
                      if pid in id_map:
                          if update_parcel_geometry(id_map[pid], geom):
                              total_updated += 1
                  
                  total_processed += len(chunk)
                  time.sleep(0.3)  # Rate limit
              
              last_id = parcels[-1]["id"]
              
              if round_num % 10 == 0:
                  print(f"Round {round_num}: {total_processed:,} processed, {total_updated:,} updated (last_id={last_id})")

          print("=" * 70)
          print(f"COMPLETE: {total_processed:,} processed, {total_updated:,} updated")
          print(f"Last ID: {last_id}")
          print("=" * 70)
          PYTHON_SCRIPT

      - name: Verify geometry counts
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "=== Geometry Stats ==="
          python3 << 'EOF'
          import requests, os
          
          url = os.environ["SUPABASE_URL"]
          key = os.environ["SUPABASE_SERVICE_KEY"]
          headers = {"apikey": key, "Authorization": f"Bearer {key}"}
          
          r = requests.get(f"{url}/rest/v1/sample_properties?select=id&geometry=not.is.null",
              headers={**headers, "Prefer": "count=exact"})
          with_geom = r.headers.get("content-range", "0/0").split("/")[-1]
          
          r2 = requests.get(f"{url}/rest/v1/sample_properties?select=id",
              headers={**headers, "Prefer": "count=exact"})
          total = r2.headers.get("content-range", "0/0").split("/")[-1]
          
          print(f"With geometry: {with_geom}")
          print(f"Total parcels: {total}")
          pct = (int(with_geom) / int(total) * 100) if total.isdigit() and int(total) > 0 else 0
          print(f"Coverage: {pct:.1f}%")
          EOF
