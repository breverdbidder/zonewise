name: Add Geometry via BCPAO Scan

on:
  workflow_dispatch:
    inputs:
      start_offset:
        description: 'BCPAO offset to start from'
        required: true
        default: '0'
      batch_size:
        description: 'Records per BCPAO request'
        required: true
        default: '500'

jobs:
  add-geometry:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Scan BCPAO and update Supabase
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          START_OFFSET: ${{ inputs.start_offset }}
          BATCH_SIZE: ${{ inputs.batch_size }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          import requests
          import json
          import time

          SUPABASE_URL = os.environ["SUPABASE_URL"]
          SUPABASE_KEY = os.environ["SUPABASE_SERVICE_KEY"]
          BCPAO_URL = "https://gis.brevardfl.gov/gissrv/rest/services/Base_Map/Parcel_New_WKID2881/MapServer/5/query"

          START_OFFSET = int(os.environ.get("START_OFFSET", "0"))
          BATCH_SIZE = int(os.environ.get("BATCH_SIZE", "500"))
          TOTAL_PARCELS = 351531

          headers = {
              "apikey": SUPABASE_KEY,
              "Authorization": f"Bearer {SUPABASE_KEY}",
              "Content-Type": "application/json"
          }

          def fetch_bcpao_batch(offset, limit):
              """Fetch parcels with geometry from BCPAO."""
              params = {
                  "where": "ParcelType=0",
                  "outFields": "PARCEL_ID",
                  "returnGeometry": "true",
                  "outSR": "4326",
                  "orderByFields": "OBJECTID",
                  "resultOffset": offset,
                  "resultRecordCount": limit,
                  "f": "json"
              }
              try:
                  r = requests.get(BCPAO_URL, params=params, timeout=120)
                  if r.status_code == 200:
                      data = r.json()
                      if "error" not in data:
                          return data.get("features", [])
              except Exception as e:
                  print(f"  BCPAO error: {e}")
              return []

          def batch_update_geometries(updates):
              """Update multiple parcels with geometry via individual PATCHes."""
              success = 0
              for parcel_id, geometry in updates:
                  try:
                      # URL encode the parcel_id for the query
                      r = requests.patch(
                          f"{SUPABASE_URL}/rest/v1/sample_properties",
                          headers=headers,
                          params={"parcel_id": f"eq.{parcel_id}"},
                          json={"geometry": geometry},
                          timeout=10
                      )
                      if r.status_code in [200, 204]:
                          success += 1
                  except:
                      pass
              return success

          print("=" * 70)
          print("ZoneWise - Geometry via BCPAO Scan")
          print(f"Start offset: {START_OFFSET} | Batch: {BATCH_SIZE}")
          print(f"Target: {TOTAL_PARCELS:,} parcels")
          print("=" * 70)

          offset = START_OFFSET
          total_updated = 0
          batch_num = 0

          while offset < TOTAL_PARCELS:
              batch_num += 1
              
              # Fetch from BCPAO with geometry
              features = fetch_bcpao_batch(offset, BATCH_SIZE)
              
              if not features:
                  print(f"  Empty batch at offset {offset}, retrying...")
                  time.sleep(2)
                  features = fetch_bcpao_batch(offset, BATCH_SIZE)
                  if not features:
                      print(f"  Still empty, skipping...")
                      offset += BATCH_SIZE
                      continue
              
              # Prepare updates
              updates = []
              for f in features:
                  pid = f.get("attributes", {}).get("PARCEL_ID")
                  geom = f.get("geometry")
                  if pid and geom:
                      updates.append((pid, geom))
              
              # Update Supabase
              updated = batch_update_geometries(updates)
              total_updated += updated
              
              pct = (offset / TOTAL_PARCELS) * 100
              if batch_num % 20 == 0:
                  print(f"Batch {batch_num}: offset={offset:,} ({pct:.1f}%), {total_updated:,} updated")
              
              offset += BATCH_SIZE
              time.sleep(0.5)

          print("=" * 70)
          print(f"COMPLETE: {total_updated:,} parcels updated with geometry")
          print(f"Final offset: {offset}")
          print("=" * 70)
          PYTHON_SCRIPT

      - name: Verify
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          python3 << 'EOF'
          import requests, os
          url = os.environ["SUPABASE_URL"]
          key = os.environ["SUPABASE_SERVICE_KEY"]
          headers = {"apikey": key, "Authorization": f"Bearer {key}", "Prefer": "count=exact"}
          
          r = requests.get(f"{url}/rest/v1/sample_properties?select=id&geometry=not.is.null", headers=headers)
          with_geom = r.headers.get("content-range", "0/0").split("/")[-1]
          
          r2 = requests.get(f"{url}/rest/v1/sample_properties?select=id", headers=headers)
          total = r2.headers.get("content-range", "0/0").split("/")[-1]
          
          print(f"With geometry: {with_geom}")
          print(f"Total: {total}")
          EOF
