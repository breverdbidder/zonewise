name: Greptile Code Analysis

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC (1 AM EST)
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - bugs
          - security
          - performance

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Greptile Analysis
        id: greptile
        run: |
          ANALYSIS_TYPE="${{ github.event.inputs.analysis_type || 'full' }}"
          
          case $ANALYSIS_TYPE in
            "full")
              QUERY="Give a comprehensive code review: bugs, security issues, performance problems, missing tests, and architectural improvements needed. List each with file paths."
              ;;
            "bugs")
              QUERY="Find all potential bugs, error handling gaps, and edge cases that could cause failures. List each with file paths and severity."
              ;;
            "security")
              QUERY="Perform a security audit: find injection vulnerabilities, authentication issues, data exposure risks, and missing input validation."
              ;;
            "performance")
              QUERY="Identify performance bottlenecks: slow queries, missing caching, inefficient algorithms, and memory issues."
              ;;
          esac
          
          RESPONSE=$(curl -s -X POST "https://api.greptile.com/v2/query" \
            -H "Authorization: Bearer ${{ secrets.GREPTILE_API_KEY }}" \
            -H "X-GitHub-Token: ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"messages\": [{\"role\": \"user\", \"content\": \"$QUERY\"}],
              \"repositories\": [{\"remote\": \"github\", \"repository\": \"${{ github.repository }}\", \"branch\": \"main\"}],
              \"genius\": true
            }")
          
          MESSAGE=$(echo "$RESPONSE" | jq -r '.message // "Analysis failed"')
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Issue with Findings
        uses: actions/github-script@v7
        with:
          script: |
            const analysis = `${{ steps.greptile.outputs.analysis }}`;
            const analysisType = '${{ github.event.inputs.analysis_type || "full" }}';
            const date = new Date().toISOString().split('T')[0];
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Greptile] ${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)} Analysis - ${date}`,
              body: `## Automated Greptile Code Analysis

**Type:** ${analysisType}
**Date:** ${date}

---

${analysis}

---

*This issue was automatically generated by Greptile code analysis.*`,
              labels: ['greptile', 'automated', analysisType]
            });

      - name: Log to Supabase
        run: |
          curl -s -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/insights" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"type\": \"greptile_analysis\",
              \"repo\": \"${{ github.repository }}\",
              \"analysis_type\": \"${{ github.event.inputs.analysis_type || 'full' }}\",
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }"
