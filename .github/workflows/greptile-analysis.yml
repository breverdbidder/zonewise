name: Greptile Code Analysis

on:
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      analysis_type:
        description: Type of analysis
        required: true
        default: full
        type: choice
        options:
          - full
          - bugs
          - security
          - performance

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Greptile Analysis
        id: greptile
        env:
          GREPTILE_API_KEY: ${{ secrets.GREPTILE_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ANALYSIS_TYPE="${{ github.event.inputs.analysis_type || 'full' }}"
          
          case $ANALYSIS_TYPE in
            "full")
              QUERY="Give a comprehensive code review: architecture issues, missing tests, error handling gaps. List top 10 priorities with file paths."
              ;;
            "bugs")
              QUERY="Find potential bugs and error handling gaps. List each with file paths and severity."
              ;;
            "security")
              QUERY="Perform security audit: injection vulnerabilities, auth issues, data exposure risks."
              ;;
            "performance")
              QUERY="Identify performance bottlenecks: slow queries, missing caching, inefficient code."
              ;;
          esac
          
          RESPONSE=$(curl -s -X POST "https://api.greptile.com/v2/query" \
            -H "Authorization: Bearer $GREPTILE_API_KEY" \
            -H "X-GitHub-Token: $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"messages\": [{\"role\": \"user\", \"content\": \"$QUERY\"}], \"repositories\": [{\"remote\": \"github\", \"repository\": \"${{ github.repository }}\", \"branch\": \"main\"}]}")
          
          MESSAGE=$(echo "$RESPONSE" | jq -r '.message // "Analysis failed - check Greptile API"')
          
          # Save to file for issue creation
          echo "$MESSAGE" > /tmp/analysis.md
          
          echo "analysis_type=$ANALYSIS_TYPE" >> $GITHUB_OUTPUT

      - name: Create Issue with Analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y-%m-%d)
          TYPE="${{ steps.greptile.outputs.analysis_type }}"
          
          BODY="## Automated Greptile Code Analysis

**Type:** $TYPE
**Date:** $DATE
**Repository:** ${{ github.repository }}

---

$(cat /tmp/analysis.md)

---

*This issue was automatically generated by the Greptile Code Analysis workflow.*"

          gh issue create \
            --title "[Greptile] $TYPE Analysis - $DATE" \
            --body "$BODY" \
            --label "greptile,automated,$TYPE"
