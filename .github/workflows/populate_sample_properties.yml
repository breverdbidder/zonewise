name: Populate ALL Brevard Parcels

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Records per API call (max 1000)'
        required: true
        default: '1000'
      start_offset:
        description: 'Starting offset (for resuming)'
        required: true
        default: '0'
      max_records:
        description: 'Max records to fetch (0 = all ~351K)'
        required: true
        default: '0'

jobs:
  populate-all:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Fetch and insert ALL parcels
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BATCH_SIZE: ${{ inputs.batch_size }}
          START_OFFSET: ${{ inputs.start_offset }}
          MAX_RECORDS: ${{ inputs.max_records }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          import requests
          import time
          import sys

          SUPABASE_URL = os.environ["SUPABASE_URL"]
          SUPABASE_KEY = os.environ["SUPABASE_SERVICE_KEY"]
          BCPAO_URL = "https://gis.brevardfl.gov/gissrv/rest/services/Base_Map/Parcel_New_WKID2881/MapServer/5/query"
          
          BATCH_SIZE = int(os.environ.get("BATCH_SIZE", "1000"))
          START_OFFSET = int(os.environ.get("START_OFFSET", "0"))
          MAX_RECORDS = int(os.environ.get("MAX_RECORDS", "0"))

          headers = {
              "apikey": SUPABASE_KEY,
              "Authorization": f"Bearer {SUPABASE_KEY}",
              "Content-Type": "application/json",
              "Prefer": "resolution=ignore-duplicates"
          }

          # City to Jurisdiction ID mapping
          CITY_TO_JURISDICTION = {
              "MELBOURNE": 1,
              "PALM BAY": 2,
              "INDIAN HARBOUR BEACH": 3,
              "TITUSVILLE": 4,
              "COCOA": 5,
              "SATELLITE BEACH": 6,
              "COCOA BEACH": 7,
              "ROCKLEDGE": 8,
              "WEST MELBOURNE": 9,
              "CAPE CANAVERAL": 10,
              "INDIALANTIC": 11,
              "MELBOURNE BEACH": 12,
              "MALABAR": 14,
              "GRANT VALKARIA": 15,
              "GRANT-VALKARIA": 15,
              "PALM SHORES": 16,
              "MELBOURNE VILLAGE": 17,
          }

          def get_jurisdiction_id(city):
              """Map city name to jurisdiction ID, default to 13 (Unincorporated)."""
              if not city:
                  return 13
              city_upper = city.upper().strip()
              return CITY_TO_JURISDICTION.get(city_upper, 13)

          def query_bcpao_batch(offset, limit):
              """Query BCPAO with pagination using resultOffset."""
              params = {
                  "where": "ParcelType=0",
                  "outFields": "PARCEL_ID,TaxAcct,STREET_NUMBER,STREET_NAME,STREET_TYPE,CITY,STATE,ZIP_CODE,ACRES,LAND_VALUE,BLDG_VALUE,USE_CODE,USE_CODE_DESCRIPTION",
                  "returnGeometry": "false",
                  "orderByFields": "OBJECTID",
                  "resultOffset": offset,
                  "resultRecordCount": limit,
                  "f": "json"
              }
              
              try:
                  r = requests.get(BCPAO_URL, params=params, timeout=60)
                  data = r.json()
                  
                  if "error" in data:
                      print(f"  API Error: {data['error']}")
                      return [], False
                  
                  features = data.get("features", [])
                  exceeded = data.get("exceededTransferLimit", False)
                  
                  return features, exceeded or len(features) == limit
              except Exception as e:
                  print(f"  Request error: {e}")
                  return [], False

          def insert_batch(records):
              """Insert batch to Supabase with upsert."""
              if not records:
                  return 0
              
              # Split into chunks of 500 for Supabase
              chunk_size = 500
              total_inserted = 0
              
              for i in range(0, len(records), chunk_size):
                  chunk = records[i:i+chunk_size]
                  try:
                      r = requests.post(
                          f"{SUPABASE_URL}/rest/v1/sample_properties",
                          headers=headers,
                          json=chunk,
                          timeout=120
                      )
                      if r.status_code in [200, 201]:
                          total_inserted += len(chunk)
                      else:
                          print(f"    Insert error: {r.status_code} - {r.text[:100]}")
                  except Exception as e:
                      print(f"    Insert exception: {e}")
              
              return total_inserted

          def transform_features(features):
              """Transform BCPAO features to sample_properties records."""
              records = []
              for f in features:
                  a = f.get("attributes", {})
                  
                  addr = " ".join(filter(None, [
                      str(a.get("STREET_NUMBER", "")).strip(),
                      str(a.get("STREET_NAME", "")).strip(),
                      str(a.get("STREET_TYPE", "")).strip()
                  ]))
                  
                  parcel_id = a.get("PARCEL_ID")
                  if not parcel_id:
                      continue
                  
                  city = a.get("CITY")
                  jurisdiction_id = get_jurisdiction_id(city)
                  
                  records.append({
                      "jurisdiction_id": jurisdiction_id,
                      "parcel_id": parcel_id,
                      "tax_account": str(a.get("TaxAcct")) if a.get("TaxAcct") else None,
                      "address": addr if addr.strip() else None,
                      "city": city,
                      "state": a.get("STATE", "FL"),
                      "zip_code": a.get("ZIP_CODE"),
                      "acres": a.get("ACRES"),
                      "land_value": a.get("LAND_VALUE"),
                      "building_value": a.get("BLDG_VALUE"),
                      "use_code": a.get("USE_CODE"),
                      "use_description": a.get("USE_CODE_DESCRIPTION")
                  })
              
              return records

          # Main execution
          print("=" * 70)
          print("ZoneWise - FULL Brevard County Parcel Extraction")
          print(f"BCPAO Total: ~351,531 parcels")
          print(f"Batch size: {BATCH_SIZE}")
          print(f"Starting offset: {START_OFFSET}")
          print(f"Max records: {MAX_RECORDS if MAX_RECORDS > 0 else 'ALL'}")
          print("=" * 70)

          offset = START_OFFSET
          total_fetched = 0
          total_inserted = 0
          batch_num = 0
          has_more = True
          errors = 0
          max_errors = 10

          while has_more:
              batch_num += 1
              print(f"\nBatch {batch_num}: offset={offset}...")
              
              features, has_more = query_bcpao_batch(offset, BATCH_SIZE)
              
              if not features:
                  errors += 1
                  if errors >= max_errors:
                      print(f"Too many errors ({errors}), stopping.")
                      break
                  print(f"  Empty batch, retrying in 5s... (error {errors}/{max_errors})")
                  time.sleep(5)
                  continue
              
              errors = 0  # Reset error count on success
              total_fetched += len(features)
              
              records = transform_features(features)
              inserted = insert_batch(records)
              total_inserted += inserted
              
              print(f"  âœ“ Fetched: {len(features)}, Inserted: {inserted}")
              print(f"  Running total: {total_fetched:,} fetched, {total_inserted:,} inserted")
              
              offset += BATCH_SIZE
              
              # Check max records limit
              if MAX_RECORDS > 0 and total_fetched >= MAX_RECORDS:
                  print(f"\nReached max records limit ({MAX_RECORDS})")
                  break
              
              # Rate limiting
              time.sleep(0.5)
              
              # Progress checkpoint every 50 batches
              if batch_num % 50 == 0:
                  print(f"\n{'='*40}")
                  print(f"CHECKPOINT: {total_fetched:,} records processed")
                  print(f"Next offset: {offset}")
                  print(f"{'='*40}\n")

          print("\n" + "=" * 70)
          print("EXTRACTION COMPLETE")
          print(f"Total batches: {batch_num}")
          print(f"Total fetched: {total_fetched:,}")
          print(f"Total inserted: {total_inserted:,}")
          print(f"Final offset: {offset}")
          print("=" * 70)
          PYTHON_SCRIPT
      
      - name: Verify final counts
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "=== Final Verification ==="
          
          # Get total count
          TOTAL=$(curl -s "$SUPABASE_URL/rest/v1/sample_properties?select=id" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Prefer: count=exact" -I | grep -i "x-total-count" | cut -d: -f2 | tr -d ' \r')
          
          echo "Total parcels in sample_properties: $TOTAL"
          
          # Count by jurisdiction
          echo ""
          echo "=== Counts by Jurisdiction ==="
          curl -s "$SUPABASE_URL/rest/v1/rpc/count_by_jurisdiction" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -d '{}' 2>/dev/null || echo "RPC not available, skipping jurisdiction breakdown"
