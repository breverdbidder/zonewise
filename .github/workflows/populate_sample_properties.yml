name: Populate ALL Brevard Parcels

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Records per API call (max 1000)'
        required: true
        default: '1000'
      start_offset:
        description: 'Starting offset (for resuming)'
        required: true
        default: '0'
      max_records:
        description: 'Max records to fetch (0 = all ~351K)'
        required: true
        default: '0'

jobs:
  populate-all:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch and insert ALL parcels
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BATCH_SIZE: ${{ inputs.batch_size }}
          START_OFFSET: ${{ inputs.start_offset }}
          MAX_RECORDS: ${{ inputs.max_records }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          import requests
          import time

          SUPABASE_URL = os.environ["SUPABASE_URL"]
          SUPABASE_KEY = os.environ["SUPABASE_SERVICE_KEY"]
          BCPAO_URL = "https://gis.brevardfl.gov/gissrv/rest/services/Base_Map/Parcel_New_WKID2881/MapServer/5/query"

          BATCH_SIZE = int(os.environ.get("BATCH_SIZE", "1000"))
          START_OFFSET = int(os.environ.get("START_OFFSET", "0"))
          MAX_RECORDS = int(os.environ.get("MAX_RECORDS", "0"))

          # UPSERT headers - on conflict, merge/ignore
          headers = {
              "apikey": SUPABASE_KEY,
              "Authorization": f"Bearer {SUPABASE_KEY}",
              "Content-Type": "application/json",
              "Prefer": "resolution=merge-duplicates"
          }

          CITY_TO_JURISDICTION = {
              "MELBOURNE": 1, "PALM BAY": 2, "INDIAN HARBOUR BEACH": 3,
              "TITUSVILLE": 4, "COCOA": 5, "SATELLITE BEACH": 6,
              "COCOA BEACH": 7, "ROCKLEDGE": 8, "WEST MELBOURNE": 9,
              "CAPE CANAVERAL": 10, "INDIALANTIC": 11, "MELBOURNE BEACH": 12,
              "MALABAR": 14, "GRANT VALKARIA": 15, "GRANT-VALKARIA": 15,
              "PALM SHORES": 16, "MELBOURNE VILLAGE": 17,
          }

          def get_jurisdiction_id(city):
              if not city:
                  return 13
              return CITY_TO_JURISDICTION.get(city.upper().strip(), 13)

          def query_bcpao_batch(offset, limit):
              params = {
                  "where": "ParcelType=0",
                  "outFields": "PARCEL_ID,TaxAcct,STREET_NUMBER,STREET_NAME,STREET_TYPE,CITY,STATE,ZIP_CODE,ACRES,LAND_VALUE,BLDG_VALUE,USE_CODE,USE_CODE_DESCRIPTION",
                  "returnGeometry": "false",
                  "orderByFields": "OBJECTID",
                  "resultOffset": offset,
                  "resultRecordCount": limit,
                  "f": "json"
              }
              try:
                  r = requests.get(BCPAO_URL, params=params, timeout=60)
                  data = r.json()
                  if "error" in data:
                      print(f"  API Error: {data['error']}")
                      return [], False
                  features = data.get("features", [])
                  return features, len(features) == limit
              except Exception as e:
                  print(f"  Request error: {e}")
                  return [], False

          def upsert_batch(records):
              """Upsert with ON CONFLICT handling via RPC or chunked POST."""
              if not records:
                  return 0
              
              chunk_size = 200  # Smaller chunks for reliability
              total_upserted = 0
              
              for i in range(0, len(records), chunk_size):
                  chunk = records[i:i+chunk_size]
                  try:
                      # Use POST with upsert header
                      r = requests.post(
                          f"{SUPABASE_URL}/rest/v1/sample_properties",
                          headers=headers,
                          json=chunk,
                          timeout=120
                      )
                      if r.status_code in [200, 201]:
                          total_upserted += len(chunk)
                      elif r.status_code == 409:
                          # Duplicate - try one by one
                          for rec in chunk:
                              try:
                                  r2 = requests.post(
                                      f"{SUPABASE_URL}/rest/v1/sample_properties",
                                      headers=headers,
                                      json=[rec],
                                      timeout=30
                                  )
                                  if r2.status_code in [200, 201]:
                                      total_upserted += 1
                              except:
                                  pass
                      else:
                          print(f"    Chunk error: {r.status_code}")
                  except Exception as e:
                      print(f"    Exception: {e}")
              
              return total_upserted

          def transform_features(features):
              records = []
              for f in features:
                  a = f.get("attributes", {})
                  parcel_id = a.get("PARCEL_ID")
                  if not parcel_id:
                      continue
                  
                  addr = " ".join(filter(None, [
                      str(a.get("STREET_NUMBER", "")).strip(),
                      str(a.get("STREET_NAME", "")).strip(),
                      str(a.get("STREET_TYPE", "")).strip()
                  ]))
                  
                  records.append({
                      "jurisdiction_id": get_jurisdiction_id(a.get("CITY")),
                      "parcel_id": parcel_id,
                      "tax_account": str(a.get("TaxAcct")) if a.get("TaxAcct") else None,
                      "address": addr if addr.strip() else None,
                      "city": a.get("CITY"),
                      "state": a.get("STATE", "FL"),
                      "zip_code": a.get("ZIP_CODE"),
                      "acres": a.get("ACRES"),
                      "land_value": a.get("LAND_VALUE"),
                      "building_value": a.get("BLDG_VALUE"),
                      "use_code": a.get("USE_CODE"),
                      "use_description": a.get("USE_CODE_DESCRIPTION")
                  })
              return records

          print("=" * 70)
          print("ZoneWise - FULL Brevard County Parcel Extraction")
          print(f"Target: ~351,531 parcels | Batch: {BATCH_SIZE} | Start: {START_OFFSET}")
          print("=" * 70)

          offset = START_OFFSET
          total_fetched = 0
          total_upserted = 0
          batch_num = 0
          has_more = True
          errors = 0

          while has_more:
              batch_num += 1
              features, has_more = query_bcpao_batch(offset, BATCH_SIZE)

              if not features:
                  errors += 1
                  if errors >= 10:
                      print(f"Too many errors, stopping at offset {offset}")
                      break
                  time.sleep(5)
                  continue

              errors = 0
              total_fetched += len(features)
              records = transform_features(features)
              upserted = upsert_batch(records)
              total_upserted += upserted

              if batch_num % 25 == 0:
                  print(f"Batch {batch_num}: {total_fetched:,} fetched, {total_upserted:,} upserted")

              offset += BATCH_SIZE

              if MAX_RECORDS > 0 and total_fetched >= MAX_RECORDS:
                  break

              time.sleep(0.2)

          print("=" * 70)
          print(f"COMPLETE: {total_fetched:,} fetched, {total_upserted:,} upserted")
          print("=" * 70)
          PYTHON_SCRIPT

      - name: Verify final counts
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "=== Final Count ==="
          curl -s "$SUPABASE_URL/rest/v1/sample_properties?select=id" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Prefer: count=exact" -I 2>/dev/null | grep -i "x-total-count"

          echo ""
          echo "=== By Jurisdiction ==="
          curl -s "$SUPABASE_URL/rest/v1/rpc/count_by_jurisdiction" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -d '{}' | python3 -m json.tool || echo "RPC failed"
