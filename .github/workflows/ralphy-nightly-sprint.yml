# =============================================================================
# RALPHY NIGHTLY SPRINT V2 - PR Mode for Greptile Review
# =============================================================================
# Creates PRs instead of direct commits so Greptile can review before merge
# =============================================================================

name: Ralphy Nightly Sprint

on:
  schedule:
    # 11 PM EST = 4 AM UTC
    - cron: '0 4 * * *'
  
  workflow_dispatch:
    inputs:
      max_tasks:
        description: 'Maximum tasks to process'
        required: false
        default: '10'
        type: string
      create_prs:
        description: 'Create PRs for Greptile review'
        required: false
        default: true
        type: boolean

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CREATE_PRS: ${{ github.event.inputs.create_prs || 'true' }}

jobs:
  sprint-run:
    name: Execute Sprint Tasks (PR Mode)
    runs-on: ubuntu-latest
    timeout-minutes: 420  # 7 hours max
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          npm install -g @anthropic-ai/claude-code
          pip install httpx
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Configure Git
        run: |
          git config --global user.name "Ralphy Sprint Bot"
          git config --global user.email "ralphy@biddeed.ai"
      
      - name: Check Pending Tasks
        id: check-tasks
        run: |
          TASK_COUNT=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/sprint_tasks?status=eq.pending&select=id" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" | jq '. | length')
          
          echo "pending_tasks=$TASK_COUNT" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Found $TASK_COUNT pending tasks"
      
      - name: Run Ralphy Sprint (PR Mode)
        if: steps.check-tasks.outputs.pending_tasks != '0'
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x scripts/ralphy_sprint_runner.sh
          
          MAX_TASKS="${{ github.event.inputs.max_tasks || '10' }}"
          
          if [ "$CREATE_PRS" = "true" ]; then
            echo "ðŸ”€ PR Mode: Creating PRs for Greptile review"
            ./scripts/ralphy_sprint_runner.sh --max-tasks "$MAX_TASKS"
          else
            echo "âš¡ Direct Mode: Committing directly (not recommended)"
            ./scripts/ralphy_sprint_runner.sh --max-tasks "$MAX_TASKS" --no-pr
          fi
      
      - name: Generate Sprint Report
        if: always()
        run: |
          echo "## ðŸƒ Ralphy Sprint Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** PR Creation for Greptile Review" >> $GITHUB_STEP_SUMMARY
          echo "**Pending Tasks:** ${{ steps.check-tasks.outputs.pending_tasks }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Greptile will automatically review created PRs" >> $GITHUB_STEP_SUMMARY
          echo "2. Review Greptile's feedback" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge approved PRs" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "logs/ralphy" ]; then
            LATEST_LOG=$(ls -t logs/ralphy/sprint_run_*.log 2>/dev/null | head -1)
            if [ -n "$LATEST_LOG" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Recent Log" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -30 "$LATEST_LOG" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ralphy-logs-${{ github.run_id }}
          path: logs/ralphy/
          retention-days: 30

  notify-failure:
    name: Notify on Failure
    needs: sprint-run
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Log Failure
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          curl -X POST \
            "${SUPABASE_URL}/rest/v1/insights" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "source": "ralphy_github_action",
              "type": "sprint_failure",
              "message": "Nightly sprint failed",
              "metadata": {
                "run_id": "${{ github.run_id }}",
                "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            }'
